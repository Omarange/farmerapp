# add at top with the other imports
from fastapi.responses import HTMLResponse, PlainTextResponse
import logging
logger = logging.getLogger("uvicorn.error")

# keep your existing BASE_DIR, STATIC_DIR, INDEX_PATH
# e.g.
# BASE_DIR = Path(__file__).parent
# STATIC_DIR = BASE_DIR / "static"
# INDEX_PATH = BASE_DIR / "index.html"

@app.get("/", response_class=HTMLResponse)
def site():
    try:
        if INDEX_PATH.exists():
            return FileResponse(str(INDEX_PATH))  # use str for Windows safety
        # Fallback inline HTML if index.html missing
        logger.warning("index.html NOT FOUND at %s", INDEX_PATH)
        return HTMLResponse(f"""<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡¶ï‡ßÉ‡¶∑‡¶ï ‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="wrap">
    <header><h1>üå± ‡¶ï‡ßÉ‡¶∑‡¶ï ‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ</h1><p class="sub">‡¶Ö‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú (index.html ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø)</p></header>
    <main class="card">
      <div id="log" class="log"></div>
      <div class="controls">
        <input id="msg" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."><button id="send">‚û§</button>
        <button id="mic">üéô ‡¶¨‡¶≤‡ßÅ‡¶®</button><button id="stop">‚èπ ‡¶•‡¶æ‡¶Æ‡¶æ‡¶®</button>
      </div>
    </main>
  </div>
  <script>window.CHAT_API_BASE = '';</script>
  <script src="/static/app.js"></script>
</body>
</html>""")
    except Exception as e:
        logger.exception("Error serving /: %s", e)
        return PlainTextResponse("Homepage error: " + str(e), status_code=500)

# Diagnostic endpoint to see resolved paths on Render
@app.get("/__diag", response_class=PlainTextResponse)
def diag():
    lines = [
        f"cwd={Path.cwd()}",
        f"__file__={__file__}",
        f"BASE_DIR={BASE_DIR}",
        f"STATIC_DIR={STATIC_DIR} exists={STATIC_DIR.exists()} list={list(STATIC_DIR.glob('*')) if STATIC_DIR.exists() else 'N/A'}",
        f"INDEX_PATH={INDEX_PATH} exists={INDEX_PATH.exists()}",
    ]
    return "\n".join(map(str, lines))
